name: Build and Release Ladybird Browser

permissions:
  contents: write

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.1)"
        required: true
        type: string
  schedule:
    # Run twice daily at 00:00 and 12:00 UTC
    - cron: "0 0,12 * * *"

env:
  BUILD_PRESET: Release
  LADYBIRD_REPO: https://github.com/LadybirdBrowser/ladybird.git

jobs:
  build-ubuntu:
    name: Build on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - name: Checkout builder repository
        uses: actions/checkout@v4

      - name: Clone Ladybird repository
        run: |
          git clone --depth 1 $LADYBIRD_REPO ladybird-src
          cd ladybird-src
          git submodule update --init --recursive

      - name: Install Ubuntu dependencies
        run: |
          sudo apt update
          sudo apt install -y autoconf autoconf-archive automake build-essential ccache cmake curl fonts-liberation2 git libdrm-dev libgl1-mesa-dev libtool nasm ninja-build pkg-config python3-venv qt6-base-dev qt6-tools-dev-tools qt6-wayland tar unzip zip libpulse-dev

      - name: Install CMake 3.25+
        run: |
          wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | sudo tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/kitware.list
          sudo apt update
          sudo apt install -y cmake

      - name: Setup GCC-14 compiler
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt update
          sudo apt install -y g++-14 libstdc++-14-dev

      - name: Build Ladybird
        working-directory: ladybird-src
        run: |
          ./Meta/ladybird.py build

      - name: Package Ubuntu binary as tarball
        run: |
          mkdir -p artifacts
          cd ladybird-src/Build/release/bin
          tar -czf ../../../../artifacts/ladybird-ubuntu.tar.gz .
          cd ../../../..

      - name: Upload Ubuntu artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-ubuntu
          path: artifacts/ladybird-ubuntu.tar.gz
          retention-days: 7

  build-fedora:
    name: Build on Fedora
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
      - name: Install Fedora dependencies as root
        run: |
          dnf update -y
          dnf install -y autoconf-archive automake ccache cmake curl git libdrm-devel liberation-sans-fonts libglvnd-devel libtool nasm ninja-build patchelf perl-FindBin perl-IPC-Cmd perl-lib perl-Time-Piece qt6-qtbase-devel qt6-qttools-devel qt6-qtwayland-devel tar unzip zip zlib-ng-compat-static pulseaudio-libs-devel shadow-utils sudo

      - name: Setup non-root user
        run: |
          # Create a non-root user matching GitHub runner
          useradd -m -u 1001 runner
          echo "runner ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/runner

      - name: Checkout builder repository
        uses: actions/checkout@v4

      - name: Clone Ladybird repository as non-root
        run: |
          su runner -c "git clone --depth 1 $LADYBIRD_REPO ladybird-src"
          su runner -c "cd ladybird-src && git submodule update --init --recursive"

      - name: Build Ladybird as non-root
        working-directory: ladybird-src
        run: |
          # Build as non-root user to avoid Ladybird's root detection
          su runner -c "./Meta/ladybird.py build"

      - name: Package Fedora binary as tarball
        run: |
          mkdir -p artifacts
          cd ladybird-src/Build/release/bin
          tar -czf ../../../../artifacts/ladybird-fedora.tar.gz .
          cd ../../../..
          # Fix ownership so release job can access files
          chown -R 1001:1001 artifacts/

      - name: Upload Fedora artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-fedora
          path: artifacts/ladybird-fedora.tar.gz
          retention-days: 7

  create-release:
    name: Create Release
    needs: [build-ubuntu, build-fedora]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Clean artifacts directory
        run: |
          # Remove everything except the tarballs we want to release
          find artifacts -type f -not -name "*.tar.gz" -delete
          find artifacts -type d -empty -delete
          echo "=== Artifacts after cleaning ==="
          find artifacts -type f

      - name: Get current version
        id: current_version
        run: |
          # Try to get latest tag, fallback to version file, then to default
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || cat .github/version.txt 2>/dev/null || echo "v1.0.0")
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Current latest tag: $LATEST_TAG"

      - name: Determine new version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            CURRENT_VERSION=${{ steps.current_version.outputs.LATEST_TAG }}
            VERSION_NUM=${CURRENT_VERSION#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NUM"
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
            echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
            # Update version file for consistency
            echo "v${NEW_VERSION}" > .github/version.txt
          fi
          echo "Using version: ${{ steps.version.outputs.VERSION }}"

      - name: Create and push tag (for main branch releases)
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name != 'schedule'
        run: |
          NEW_VERSION="${{ steps.version.outputs.VERSION }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # Check if tag already exists before creating it
          if git rev-parse "v${NEW_VERSION}" >/dev/null 2>&1; then
            echo "Tag v${NEW_VERSION} already exists, skipping tag creation"
          else
            git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"
            git push origin "v${NEW_VERSION}"
            # Update version file to match the new tag
            echo "v${NEW_VERSION}" > .github/version.txt
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Ladybird Browser v${{ steps.version.outputs.VERSION }}
          body: |
            # Ladybird Browser v${{ steps.version.outputs.VERSION }}

            Automated build of Ladybird Browser

            ## Build Information:
            - Commit: ${{ github.sha }}
            - Build Date: ${{ github.event.head_commit.timestamp }}
            - Trigger: ${{ github.event_name }}

            ## Available Binaries:
            - Ubuntu (GCC 14) - Portable binary directory
            - Fedora - Portable binary directory

            ## Installation:
            1. Download the appropriate tarball for your distribution
            2. Extract the files: `tar -xzf ladybird-ubuntu.tar.gz` (or ladybird-fedora.tar.gz)
            3. Run `./Ladybird` to start the browser

            **Note:** This is an automated build. For official releases, please check the main Ladybird repository.
          draft: false
          prerelease: false
          files: |
            artifacts/ladybird-ubuntu.tar.gz
            artifacts/ladybird-fedora.tar.gz
