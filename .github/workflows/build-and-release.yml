name: Build and Release Ladybird Browser

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run twice daily at 00:00 and 12:00 UTC
    - cron: "0 0,12 * * *"
  workflow_dispatch: # Allow manual triggering

env:
  BUILD_PRESET: Release
  VERSION_BASE: v1.0
  LADYBIRD_REPO: https://github.com/LadybirdBrowser/ladybird.git
  VCPKG_BINARY_SOURCES: "clear;nuget,GitHub,readwrite;nuget,https://api.nuget.org/v3/index.json,read"
  # GitHub runners: 4 vCPUs, 16GB RAM, improved storage

jobs:
  build-ubuntu:
    name: Build on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - name: Checkout builder repository
        uses: actions/checkout@v4

      - name: Cache vcpkg dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/vcpkg
            ladybird-src/Build/vcpkg/downloads
            ladybird-src/Build/vcpkg/buildtrees
          key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ccache-${{ runner.os }}-${{ matrix.compiler }}

      - name: Clone Ladybird repository
        run: |
          git clone --depth 1 --shallow-submodules $LADYBIRD_REPO ladybird-src
          cd ladybird-src
          git submodule update --init --depth 1

      - name: Install Ubuntu dependencies
        run: |
          sudo apt update
          sudo apt install -y autoconf autoconf-archive automake build-essential ccache cmake curl fonts-liberation2 git libdrm-dev libgl1-mesa-dev libtool nasm ninja-build pkg-config python3-venv qt6-base-dev qt6-tools-dev-tools qt6-wayland tar unzip zip libpulse-dev mesa-common-dev libglu1-mesa-dev libx11-dev libxext-dev libxi-dev libxrandr-dev libxcursor-dev libxinerama-dev libxxf86vm-dev libegl1-mesa-dev libgles2-mesa-dev libwayland-dev libxkbcommon-dev
          # Ensure ninja is available in PATH
          sudo ln -sf /usr/bin/ninja-build /usr/bin/ninja || true

      - name: Install CMake 3.25+
        run: |
          # Add Kitware GPG signing key and repository for latest CMake
          wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | sudo tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/kitware.list
          sudo apt update
          sudo apt install -y cmake

      - name: Setup GCC-14 compiler
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt update
          sudo apt install -y g++-14 libstdc++-14-dev
          echo "CC=gcc-14" >> $GITHUB_ENV
          echo "CXX=g++-14" >> $GITHUB_ENV

      - name: Check GCC version
        run: |
          echo "GCC version:"
          gcc --version
          echo "G++ version:"
          g++ --version

      - name: Bootstrap vcpkg and verify setup
        working-directory: ladybird-src
        run: |
          # Bootstrap vcpkg to ensure it's properly set up
          if [ -f "Meta/CMake/vcpkg/bootstrap-vcpkg.sh" ]; then
            chmod +x Meta/CMake/vcpkg/bootstrap-vcpkg.sh
            ./Meta/CMake/vcpkg/bootstrap-vcpkg.sh
          fi
          # Verify ninja is available
          which ninja || which ninja-build || (echo "Ninja not found" && exit 1)
          # Verify vcpkg is bootstrapped
          if [ -f "Build/vcpkg/vcpkg" ]; then
            echo "vcpkg is bootstrapped"
          else
            echo "vcpkg needs bootstrapping"
          fi

      - name: Build Ladybird (optimized)
        working-directory: ladybird-src
        run: |
          export CMAKE_BUILD_PARALLEL_LEVEL=4
          export VCPKG_MAX_CONCURRENCY=4
          export CCACHE_DIR="$HOME/.ccache"
          export VCPKG_BINARY_SOURCES="$VCPKG_BINARY_SOURCES"
          # Ensure ninja is in PATH
          export PATH="/usr/bin:$PATH"
          # Optimize for GitHub runners (4 vCPUs, 16GB RAM)
          ./Meta/ladybird.py build || (echo "Build failed, checking vcpkg logs..." && cat Build/release/vcpkg-manifest-install.log && exit 1)

      - name: Package Ubuntu binary
        run: |
          mkdir -p artifacts/ubuntu
          cp -r ladybird-src/Build/release/bin/* artifacts/ubuntu/
          # Create a simple launcher script
          cat > artifacts/ubuntu/ladybird-launcher.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          ./Ladybird "$@"
          EOF
          chmod +x artifacts/ubuntu/ladybird-launcher.sh

      - name: Upload Ubuntu artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-ubuntu
          path: artifacts/ubuntu/
          retention-days: 7

  build-fedora:
    name: Build on Fedora
    runs-on: ubuntu-latest

    container:
      image: fedora:latest

    steps:
      - name: Install Fedora dependencies
        run: |
          dnf update -y
          dnf install -y autoconf-archive automake ccache cmake curl git libdrm-devel liberation-sans-fonts libglvnd-devel libtool nasm ninja-build patchelf perl-FindBin perl-IPC-Cmd perl-lib perl-Time-Piece qt6-qtbase-devel qt6-qttools-devel qt6-qtwayland-devel tar unzip zip zlib-ng-compat-static pulseaudio-libs-devel gcc gcc-c++ python3 mesa-libGL-devel mesa-libGLU-devel libX11-devel libXext-devel libXi-devel libXrandr-devel libXcursor-devel libXinerama-devel libXxf86vm-devel mesa-libEGL-devel mesa-libGLES-devel wayland-devel libxkbcommon-devel sudo
          # Ensure ninja is available in PATH
          ln -sf /usr/bin/ninja-build /usr/bin/ninja || true

      - name: Checkout builder repository
        uses: actions/checkout@v4

      - name: Cache vcpkg dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/vcpkg
            ladybird-src/Build/vcpkg/downloads
            ladybird-src/Build/vcpkg/buildtrees
          key: vcpkg-fedora-${{ hashFiles('**/vcpkg.json') }}
          restore-keys: |
            vcpkg-fedora-

      - name: Setup ccache
        run: |
          mkdir -p ~/.ccache
          echo "max_size = 2.0G" > ~/.ccache/ccache.conf

      - name: Clone Ladybird repository
        run: |
          # Create non-root user for building
          useradd -m -u 1001 builder
          chown -R builder:builder /__w/ladybird-builder/ladybird-builder

          # Clone as non-root user with shallow submodules
          sudo -u builder git clone --depth 1 --shallow-submodules $LADYBIRD_REPO ladybird-src
          cd ladybird-src
          sudo -u builder git submodule update --init --depth 1

      - name: Check GCC version
        run: |
          echo "GCC version:"
          gcc --version
          echo "G++ version:"
          g++ --version

      - name: Bootstrap vcpkg and verify setup
        working-directory: ladybird-src
        run: |
          # Bootstrap vcpkg to ensure it's properly set up
          if [ -f "Meta/CMake/vcpkg/bootstrap-vcpkg.sh" ]; then
            chmod +x Meta/CMake/vcpkg/bootstrap-vcpkg.sh
            ./Meta/CMake/vcpkg/bootstrap-vcpkg.sh
          fi
          # Verify ninja is available
          which ninja || which ninja-build || (echo "Ninja not found" && exit 1)
          # Verify vcpkg is bootstrapped
          if [ -f "Build/vcpkg/vcpkg" ]; then
            echo "vcpkg is bootstrapped"
          else
            echo "vcpkg needs bootstrapping"
          fi

      - name: Build Ladybird (optimized)
        working-directory: ladybird-src
        run: |
          export CMAKE_BUILD_PARALLEL_LEVEL=4
          export VCPKG_MAX_CONCURRENCY=4
          export CCACHE_DIR="$HOME/.ccache"
          export VCPKG_BINARY_SOURCES="$VCPKG_BINARY_SOURCES"
          # Ensure ninja is in PATH
          export PATH="/usr/bin:$PATH"
          # Optimize for GitHub runners (4 vCPUs, 16GB RAM)
          sudo -u builder ./Meta/ladybird.py build || (echo "Build failed, checking vcpkg logs..." && cat Build/release/vcpkg-manifest-install.log && exit 1)

      - name: Package Fedora binary
        run: |
          mkdir -p artifacts/fedora
          cp -r ladybird-src/Build/release/bin/* artifacts/fedora/
          # Create a simple launcher script
          cat > artifacts/fedora/ladybird-launcher.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          ./Ladybird "$@"
          EOF
          chmod +x artifacts/fedora/ladybird-launcher.sh

      - name: Upload Fedora artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-fedora
          path: artifacts/fedora/
          retention-days: 7

  create-release:
    name: Create Release
    needs: [build-ubuntu, build-fedora]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Determine version
        id: version
        run: |
          # Get the latest release tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "$VERSION_BASE.0")

          # Extract version numbers
          if [[ $LATEST_TAG =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            PATCH=${BASH_REMATCH[3]}

            # Increment patch version
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          else
            # If no valid tag found, start from v1.0.1
            NEW_VERSION="v1.0.1"
          fi

          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "New version: $NEW_VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.NEW_VERSION }}
          name: Ladybird Browser ${{ env.NEW_VERSION }}
          body: |
            Automated build of Ladybird Browser ${{ env.NEW_VERSION }}

            **Build Information:**
            - Commit: ${{ github.sha }}
            - Build Date: ${{ github.event.head_commit.timestamp }}
            - Trigger: ${{ github.event_name }}

            **Available Artifacts:**
            - Ubuntu (GCC 14)
            - Fedora

            **Installation:**
            1. Download the appropriate archive for your distribution
            2. Extract the files
            3. Run `./ladybird-launcher.sh` to start the browser

            **Note:** This is an automated build. For official releases, please check the main Ladybird repository.
          draft: false
          prerelease: false
          files: |
            ladybird-ubuntu/**
            ladybird-fedora/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
